@page "/originalmessageboard"
@using Chatty2.Services

<span style="padding-left:10px;">Message Board for: @UTC_DB.authority</span>
<div class="message-list-wrapper">
    @* Pinned messages first, then a splitter, then non-pinned messages *@
    @if (PinnedMessages.Any())
    {
        @foreach (var message in PinnedMessages)
        {
            <div class="single-message-item @(message.IsPinned ? "pinned" : "")">

                <div class="">
                    <span class="sender">@message.Username</span>
                    <small class="timestamp">@message.Timestamp.ToLocalTime()</small>
                </div>

                <div class="message-row">
                    <div class="message-body">
                        @message.Content
                    </div>
                    <button class="btn btn-sm pin-button" @onclick="() => TogglePin(message.Id)" aria-pressed="@message.IsPinned">
                        @if (message.IsPinned)
                        {
                            <span class="oi oi-pin" title="Unpin Message"></span>
                        }
                        else
                        {
                            <span class="oi oi-pin" title="Pin Message" style="color: lightgrey;"></span>
                        }
                    </button>
                </div>

            </div>
        }
    }

    @if (PinnedMessages.Any() && UnpinnedMessages.Any())
    {
        <div class="splitter" role="separator" aria-label="Pinned / Unpinned separator">
            <span class="splitter-label">Unpinned messages</span>
        </div>
    }

    @if (UnpinnedMessages.Any())
    {
        @foreach (var message in UnpinnedMessages)
        {
            <div class="single-message-item @(message.IsPinned ? "pinned" : "")">

                <div class="">
                    <span class="sender">@message.Username</span>
                    <small class="timestamp">@message.Timestamp.ToLocalTime()</small>
                </div>

                <div class="message-row">
                    <div class="message-body">
                        @message.Content
                    </div>
                    <button class="btn btn-sm pin-button" @onclick="() => TogglePin(message.Id)" aria-pressed="@message.IsPinned">
                        @if (message.IsPinned)
                        {
                            <span class="oi oi-pin" title="Unpin Message"></span>
                        }
                        else
                        {
                            <span class="oi oi-pin" title="Pin Message" style="color: lightgrey;"></span>
                        }
                    </button>
                </div>

            </div>
        }
    }
</div>

<div class="message-input">
    <textarea rows="1" @bind="NewMessageContent" @bind:event="oninput" maxlength="@MAX_TEXT_COUNT" placeholder="Type message..."></textarea>
    <button class="rz-ripple" @onclick="PostMessage">Post</button>

</div>
<span style="font-size:9px;margin-left:20px;">@(NewMessageContent.Length)/@(MAX_TEXT_COUNT)</span>



@code {
    private List<Message> Messages { get; set; } = new List<Message>();
    private string NewMessageContent { get; set; } = string.Empty;
    // private bool ShowDateSeparator { get; set; } = false; You can implement logic for this
    // private DateTime LastMessageDate = DateTime.MinValue;
    const int MAX_TEXT_COUNT = 128;

    private IEnumerable<Message> PinnedMessages =>
        Messages
            .Where(m => m.IsPinned);
    // .OrderByDescending(m => m.Timestamp);

    private IEnumerable<Message> UnpinnedMessages =>
        Messages
            .Where(m => !m.IsPinned);
    // .OrderByDescending(m => m.Timestamp);

    

    protected override async Task OnInitializedAsync()
    {
        Messages = await UTC_DB.FetchMessagesAsync();
    }

    private async Task PostMessage()
    {
        if (!string.IsNullOrWhiteSpace(NewMessageContent))
        {
            await UTC_DB.InsertMessageAsync(new Message
            {
                Username = "You", // Or get the current logged-in user
                Content = NewMessageContent,
                Timestamp = DateTime.Now,
                IsPinned = false
            });
            //After posting need to reread the messages to re populate the list
            Messages.Clear();
            Messages = await UTC_DB.FetchMessagesAsync();
            NewMessageContent = string.Empty; // Clear the input field
        }
    }

    private async Task TogglePin(int messageId)
    {
        var message = Messages.FirstOrDefault(m => m.Id == messageId);
        if (message != null)
        {
            message.IsPinned = !message.IsPinned;
            await UTC_DB.UpdatePinnedStatus(messageId);
            // *** After posting need to reread the messages to re populate the list
            Messages.Clear();
            Messages = await UTC_DB.FetchMessagesAsync();
            // The list will be re-sorted on every render, but we trigger it here
            StateHasChanged();
        }
    }
}

<style>
    /* New CSS for the OUTER SCROLLABLE CONTAINER */
    .message-list-wrapper {
        /* box-sizing: border-box; */
        border: 1px solid red;
        border-bottom: none;
        margin: 10px;
        margin-bottom: 0px;
        padding: 10px;
        height: 400px; /* Fixed height for the viewport */
        overflow-y: auto; /* Apply the scrollbar here */
        display: flex;
        flex-direction: column;
        background-color: #fff;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        font-size: 12px;
    }

    /* Rename your old .message-container to be the single item */
    .single-message-item {
        /* Ensure the inner item does NOT have a fixed height or overflow-y */
        margin-bottom: 2px;
        padding: 0px 0px 0px 0px;
        max-width: 100%;
        word-wrap: break-word;
        background-color: transparent;
        /* border: 1px solid #aaa; */
        border-radius: 5px;
        box-shadow: none;
        align-self: stretch; /* make item stretch to container width */
    }
        /* Pinned variant: orange background */
        .single-message-item.pinned {
            background-color: #ffe066; /* orange */
            border-color: #ff8c00;
            color: #1b1b1b;
        }
            /* When pinned, show message body transparent so the orange background is visible */
            .single-message-item.pinned .message-body {
                background-color: transparent;
                color: #1b1b1b;
            }

    .message {
        margin-bottom: 12px;
        padding: 0px 0px; /* Minimal padding for a list look */
        max-width: 100%; /* Use full width */
        word-wrap: break-word;
        /* REMOVE all bubble styling */
        background-color: lightgrey;
        border-radius: 7px;
        box-shadow: none;
        align-self: flex-start; /* Ensure all messages align left */
    }

    .message-row {
        display: flex;
        align-items: flex-start;
        gap: 2px;
        width: 100%; /* ensure the row fills the item */
    }

    .message-body {
        /* border: 1px solid; */
        border-radius: 5px;
        padding: 5px 10px;
        background-color: #eee;
        color: #333;
        flex: 1 1 auto; /* stretch to fill remaining space */
        min-width: 0; /* allow shrinking inside flex container */
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: break-word;
    }

    .pin-button {
        flex: 0 0 auto; /* never grow, don't shrink below content */
        align-self: center;
        margin-left: 4px;
        height: auto;
        outline: none;
    }
        /* Prevent focus ring for mouse/touch (non-keyboard) interactions */
        .pin-button:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

    /* Keep an accessible visible focus for keyboard users */
    /* .pin-button:focus-visible {
                outline: 2px solid rgba(0, 123, 255, 0.6);
                outline-offset: 2px;
                box-shadow: none !important;
            } */



    .sender {
        /* font-weight: bold; */
        color: blue; /* Make sender stand out */
        font-size: smaller;
        margin: 0px 5px 0px 5px;

    }

    .timestamp {
        font-size: smaller;
        color: #777;
    }

    .message-content {
        /* font-size: 0.95em; */
        /* line-height: 1.4; */
        margin: 0px 5px; /* Ensure content starts at the edge */
    }

    /* .date-separator {
            text-align: center;
            margin: 15px 0;
            position: relative;
            font-size: 0.8em;
            color: #777;
        } */

    .message-input {
        display: flex;
        align-items: center;
        margin-left: 10px;
        margin-right: 10px;
        border: 1px solid red;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
        overflow: hidden;
        background-color: white;
        font-size: 12px;
    }

        .message-input textarea {
            flex-grow: 1;
            /* background-color: lawngreen; */
            border-radius: 5px;
            margin: 2px 10px;
            padding: 10px;
            resize: none; /* Disable manual resizing */
        }

        /* .message-input textarea:focus {

                } */

        .message-input button {
            background-color: #007bff;
            color: white;
            margin: 2px 10px;
            padding: 2px 5px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

            .message-input button:hover {
                background-color: #0056b3;
            }
</style>