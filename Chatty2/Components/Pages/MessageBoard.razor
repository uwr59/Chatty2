@page "/messageboard"
@using Chatty2.Services

<div class="messageboard-container">
    <span style="padding-left:10px;">Messageboard for: @UTC_DB.authority</span>
    <div class="message-list-wrapper">

        @* Pinned messages first, then a splitter, then non-pinned messages *@

        @if (PinnedMessages.Any())
        {
            <div class="pinned-list">
                @foreach (var message in PinnedMessages)
                {
                    <div class="single-message-item @(message.IsPinned ? "pinned" : "")">

                        <div class="">
                            <span class="sender">@message.Username</span>
                            <small class="timestamp">@message.Timestamp.ToLocalTime()</small>
                        </div>

                        <div class="message-row">
                            <div class="message-body">
                                @message.Content
                            </div>
                            <button class="btn btn-sm pin-button" @onclick="() => TogglePin(message.Id)" aria-pressed="@message.IsPinned">
                                @if (message.IsPinned)
                                {
                                    <span class="oi oi-pin" title="Unpin Message"></span>
                                }
                                else
                                {
                                    <span class="oi oi-pin" title="Pin Message" style="color: lightgrey;"></span>
                                }
                            </button>
                        </div>

                    </div>
                }
            </div>
        }


        @if (UnpinnedMessages.Any())
        {
            <div class="unpinned-list">
                @foreach (var message in UnpinnedMessages)
                {
                    <div class="single-message-item @(message.IsPinned ? "pinned" : "")">

                        <div class="">
                            <span class="sender">@message.Username</span>
                            <small class="timestamp">@message.Timestamp.ToLocalTime()</small>
                        </div>

                        <div class="message-row">
                            <div class="message-body">
                                @message.Content
                            </div>
                            <button class="btn btn-sm pin-button" @onclick="() => TogglePin(message.Id)" aria-pressed="@message.IsPinned">
                                @if (message.IsPinned)
                                {
                                    <span class="oi oi-pin" title="Unpin Message"></span>
                                }
                                else
                                {
                                    <span class="oi oi-pin" title="Pin Message" style="color: lightgrey;"></span>
                                }
                            </button>
                        </div>

                    </div>
                }
            </div>
        }
    </div>

    <div class="message-input">
        <textarea rows="1" @bind="NewMessageContent" @bind:event="oninput" maxlength="@MAX_TEXT_COUNT" placeholder="Type message..."></textarea>
        <button class="rz-ripple" @onclick="PostMessage">Post</button>

    </div>
    <span style="font-size:9px;margin-left:20px;margin-bottom:5px;">@(NewMessageContent.Length)/@(MAX_TEXT_COUNT)</span>

</div>

@code {
    private List<Message> Messages { get; set; } = new List<Message>();
    private string NewMessageContent { get; set; } = string.Empty;
    const int MAX_TEXT_COUNT = 128;

    private IEnumerable<Message> PinnedMessages => Messages.Where(m => m.IsPinned);
    private IEnumerable<Message> UnpinnedMessages => Messages.Where(m => !m.IsPinned);

    protected override async Task OnInitializedAsync()
    {
        // Subscribe so all open clients get updates
        UTC_DB.MessagesChanged += OnMessagesChanged;
        Messages = await UTC_DB.FetchMessagesAsync();
    }

    // Event handler invoked when another client changes data
    private async void OnMessagesChanged()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                Messages = await UTC_DB.FetchMessagesAsync();
                StateHasChanged();
            });
        }
        catch { /* swallow */ }
    }

    private async Task PostMessage()
    {
        if (!string.IsNullOrWhiteSpace(NewMessageContent))
        {
            await UTC_DB.InsertMessageAsync(new Message
            {
                Username = "You", // Replace with logged-in user
                Content = NewMessageContent,
                Timestamp = DateTime.Now,
                IsPinned = false
            });
            // Local refresh (remote clients will refresh via event)
            Messages = await UTC_DB.FetchMessagesAsync();
            NewMessageContent = string.Empty;
        }
    }

    private async Task TogglePin(int messageId)
    {
        var message = Messages.FirstOrDefault(m => m.Id == messageId);
        if (message != null)
        {
            message.IsPinned = !message.IsPinned; // optimistic UI
            await UTC_DB.UpdatePinnedStatus(messageId);
            Messages = await UTC_DB.FetchMessagesAsync();
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        UTC_DB.MessagesChanged -= OnMessagesChanged;
    }
}

<style>
    .messageboard-container { border: 1px solid; border-radius:5px; display:flex; flex-direction:column; height:100%; }
    .message-list-wrapper { margin: 1px; margin-bottom: 0px; padding: 1px; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; background-color: #fff; border-top-left-radius: 5px; border-top-right-radius: 5px; font-size: 12px; }
    .pinned-list { border: 1px solid blue; margin-bottom: 5px; min-height: 56px; height: auto; max-height: 312px; overflow: auto; }
    .unpinned-list { border: 1px solid blue; min-height: 240px; overflow: auto; }
    .single-message-item { margin: 2px 2px 0px 2px; padding: 0px; max-width: 100%; word-wrap: break-word; border-radius: 7px; box-shadow: none; border: 1px solid #727233; align-self: stretch; }
    .single-message-item.pinned { background-color: #ffe066; border: 1px solid #727233; color: #1b1b1b; }
    .single-message-item.pinned .message-body { background-color: transparent; color: #1b1b1b; }
    .message { margin-bottom: 12px; padding: 0px; max-width: 100%; word-wrap: break-word; background-color: lightgrey; border-radius: 7px; box-shadow: none; align-self: flex-start; }
    .message-row { display: flex; align-items: flex-start; gap: 2px; width: 100%; }
    .message-body { border-radius: 5px; padding: 5px 10px; background-color: #eee; color: #333; flex: 1 1 auto; min-width: 0; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; }
    .pin-button { flex: 0 0 auto; align-self: center; margin-left: 4px; height: auto; outline: none; }
    .pin-button:focus:not(:focus-visible) { outline: none; box-shadow: none; }
    .sender { color: blue; font-size: smaller; margin: 0px 5px; }
    .timestamp { font-size: smaller; color: #777; }
    .message-content { margin: 0px 5px; }
    .message-input { display: flex; align-items: center; margin: 1px; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; overflow: hidden; background-color: white; font-size: 12px; }
    .message-input textarea { flex-grow: 1; border-radius: 5px; margin: 4px; padding: 5px; resize: none; }
    .message-input button { background-color: #007bff; color: white; margin: 2px 10px; padding: 2px 5px; cursor: pointer; border-radius: 3px; font-size: 12px; }
    .message-input button:hover { background-color: #0056b3; }
</style>