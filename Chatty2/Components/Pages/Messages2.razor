@page "/messages2"

@using Microsoft.AspNetCore.Components.Forms;
@using System.ComponentModel.DataAnnotations;

@using Radzen
@using Radzen.Blazor
@inherits ComponentBase

@using System.Linq

<div class="p-1" style="background-color: #eee">
  
    <div class="mx-auto">
        <div style="padding:2px 10px; font-size:larger">
            Message Board
        </div>

        @* --- Message List --- *@
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">

            <div class="">
                @if (DisplayedMessages.Any())
                {
                    @foreach (var message in DisplayedMessages)
                    {
                        var isCurrentUser = message.Username.Equals(CurrentUsername, StringComparison.OrdinalIgnoreCase);

                        <div class="m-1 p-2" style="border: 1px solid red; border-radius: 7px;">
                            <div class="">
                                <div class="d-inline-flex" style="font-size:smaller">
                                    <span style="color:blue;white-space:pre">@message.Username @(isCurrentUser ? "(You)" : "")</span>
                                    <div class="">
                                        <span>@message.DateTime.ToString("dd/MM") @message.DateTime.ToString("HH:mm")</span>
                                    </div>
                                </div>

                                <p style="background-color:#eee; padding:3px 10px; border-radius:7px">@message.Content</p>

                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-center text-gray-500 italic py-4">No messages to display yet.</p>
                }
            </div>
        </div>

        @* --- Message Input Form --- *@
        <div class="bg-white border border-gray-100">

            <div style="padding:5px 10px 0px 10px; font-size:larger">
                New message
            </div>

            <EditForm Model="NewMessage" OnValidSubmit="PostMessage" class="space-y-4">
                <DataAnnotationsValidator />

                <div style="display:flex; align-items:center; gap:8px; margin:0px 5px; padding:6px;">
                    <textarea placeholder="Message..." @bind="NewMessage.Content" required rows="1"
                              style="flex:1; min-width:0; width:100%; border:1px solid #ccc; border-radius:5px; padding:6px; resize:vertical;">
                    </textarea>

                    <button type="submit" style="flex:0 0 auto; border-radius:5px; padding:6px 10px;">
                        Post
                    </button>
                </div>

            </EditForm>
        </div>
    </div>
</div>

@code {

    // --- C# Data Model ---
    public class Message
    {
        public long Id { get; set; }
        public string Username { get; set; } = string.Empty;

        [Required]
        public string Content { get; set; } = string.Empty;

        public DateTime DateTime { get; set; }
        public bool IsPinned { get; set; }
    }

    // --- Component State and Logic ---

    // The in-memory store for all messages
    private List<Message> Messages = new List<Message>();
    private Message NewMessage = new Message() { Username = "MyUser" }; // Default new message model
    private const string CurrentUsername = "MyUser"; // Simulating the current authenticated user

    // Computed property that implements the sorting/filtering logic using LINQ
    private List<Message> DisplayedMessages => Messages
        // 1. Get all pinned messages, ordered by ID (oldest pinned at top)
        .Where(m => m.IsPinned)
        .OrderBy(m => m.Id)
        .Concat(
            // 2. Get all unpinned messages, ordered by date (newest first), and take the top 20
            Messages
                .Where(m => !m.IsPinned)
                .OrderByDescending(m => m.DateTime)
                .Take(20)
        )
        .ToList();

    // Initializes the mock data on component load
    protected override void OnInitialized()
    {
        // Add mock data
        Messages.Add(new Message { Id = 1, Username = "System", Content = "Welcome to the board! This is a mock pinned message.", DateTime = DateTime.Now.AddDays(-1), IsPinned = true });
        Messages.Add(new Message { Id = 2, Username = "Alice", Content = "Ready for the new week!", DateTime = DateTime.Now.AddHours(-1), IsPinned = false });
        Messages.Add(new Message { Id = 3, Username = "Bob", Content = "Just checking in.", DateTime = DateTime.Now.AddMinutes(-50), IsPinned = false });
        Messages.Add(new Message { Id = 7, Username = "System", Content = "Another important notice. This one is also pinned.", DateTime = DateTime.Now.AddDays(-2), IsPinned = true });

        // Add 17 more recent messages to ensure we have > 20 total
        for (int i = 0; i < 17; i++)
        {
            Messages.Add(new Message
            {
                Id = 10 + i,
                Username = $"User{10 + i}",
                Content = $"Message number {10 + i} from the recent batch.",
                DateTime = DateTime.Now.AddSeconds(-i * 10),
                IsPinned = false,
            });
        }

        // Ensure the initial form username is set
        NewMessage.Username = CurrentUsername;
    }

    private void PostMessage()
    {
        // Clone the NewMessage object, fill in dynamic data, and add it to the list
        var post = new Message
        {
            Id = DateTime.Now.Ticks, // Simple unique ID
            Username = NewMessage.Username,
            Content = NewMessage.Content,
            DateTime = DateTime.Now,
            IsPinned = false
        };

        Messages.Add(post);

        // Reset the form model, keeping the username
        NewMessage.Content = string.Empty;

        // Force the component to re-render with the new message
        StateHasChanged();
    }

    private void TogglePin(long id)
    {
        var message = Messages.FirstOrDefault(m => m.Id == id);
        if (message != null)
        {
            message.IsPinned = !message.IsPinned;
            // Force the component to re-render, which re-runs DisplayedMessages
            StateHasChanged();
        }
    }
}